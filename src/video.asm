%include "video.mac"
%include "tools.mac"


; buffer.position(byte row, byte column)
%macro buffer.position 2.nolist
    xor eax, eax
    mov al, COLS
    mul byte %1
    add al, %2
    adc ah, 0
    shl ax, 1
%endmacro

section .bss
    modetext resb 10
    buffer.textcache    resw 0xf00

section .data 
    ;Formats
    format.cursor       db 0x3f
    format.text         db 0x8f
    format.select       db 0x9f
    format.search       db 0x00
    format.enter        db 0x82
    format.tap          db 0x4f

    respawntimecursor   dd 1 
    time                dd 0

    ;videoflags
    global videoflags
    videoflags          db 0
    %define hidecursor      1<<0  
    %define hideselection   1<<1
    %define hidesearch      1<<2
    %define respawcursor    1<<3
    
    ;video control
    scroll              dd 0      ;linea que marca el scroll
    
    buffer.width        dd 80
    buffer.height       dd 24
    %define buffer.length       2000 
    %define buffer.textlength   0x780
    %define buffer              0xB8000
    %define buffer.lastrow      0xb8f00

        ;     0   1   2   3   4   5   6   7   8   9   10  11  12  13  14  15  16  17  18  19  20  21  22  23  24  25  26  27  28  29  30  31  32  33  34  35  36  37  38  39  40  41  42  43  44  45  46  47  48
icon   db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;0
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;1
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0xa,0xa,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;2
       db     0xf,0xf,0xf,0xf,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xa,0xa,0xa,0xa,0x0,0x0,0xf,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf, ;3
       db     0xf,0xf,0xf,0xf,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xa,0x2,0x2,0xa,0xa,0x0,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf, ;4
       db     0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0xf, ;5
       db     0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0xf, ;6
       db     0xf,0xf,0xf,0xf,0x0,0xf,0x8,0x8,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x8,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0xa,0x0,0xf,0x8,0x8,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0xf, ;7
       db     0xf,0xf,0xf,0xf,0x0,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x0,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf, ;8
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf, ;9
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf, ;10
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0xf, ;11
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0xf,0xf, ;12
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf, ;13
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;14
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;15
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;16
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xa,0xa,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf, ;17
       db     0xf,0xf,0xf,0xf,0xf,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x2,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0xa,0xa,0x0,0x0,0xf,0xf,0xf,0xf,0xf, ;18
       db     0xf,0xf,0xf,0xf,0x0,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0x0,0xf,0xf,0xf,0xf, ;19
       db     0xf,0xf,0xf,0x0,0x0,0xa,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0x0,0xf,0xf,0xf, ;20
       db     0xf,0xf,0x0,0x0,0xa,0xa,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0x0,0xf,0xf, ;21
       db     0xf,0x0,0x0,0xa,0xa,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0xf,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0x0,0xf, ;22
       db     0xf,0x0,0xa,0xa,0x2,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0xa,0xa,0x0,0xf, ;23
       db     0xf,0x0,0x2,0x2,0x2,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0xf, ;24
       db     0xf,0x0,0x0,0x2,0x2,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf, ;25
       db     0xf,0xf,0x0,0x0,0x2,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x0,0x0,0x0,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf, ;26
       db     0xf,0xf,0xf,0x0,0x0,0x2,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x0,0x7,0x7,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf, ;27
       db     0xf,0xf,0xf,0xf,0x0,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x0,0x7,0x7,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf, ;28
       db     0xf,0xf,0xf,0xf,0xf,0x0,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf, ;29
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;30
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xf,0xf, ;31
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x7,0x7,0x7,0x0,0x0,0x7,0x7,0x7,0x7,0x0,0x0,0x0,0x7,0x7,0x7,0x0,0x0,0x0,0x7,0x7,0x7,0x0,0xf,0xf,0xf, ;32
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x7,0x7,0x7,0x0,0x0,0x0,0x0,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x0,0xf,0xf,0xf, ;33
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x7,0x7,0x7,0x0,0x2,0x2,0x0,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x0,0xf,0xf,0xf, ;34
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x0,0x7,0x7,0x0,0x0,0x2,0x0,0x0,0x7,0x7,0x0,0x0,0x0,0x0,0x7,0x7,0x0,0x0,0x0,0x0,0x7,0x7,0x0,0x0,0xf,0xf,0xf, ;35
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x0,0x7,0x7,0x7,0x0,0x2,0x2,0x0,0x7,0x7,0x7,0x0,0x2,0x0,0x7,0x7,0x7,0x0,0xf,0x0,0x7,0x7,0x7,0x0,0xf,0xf,0xf,0xf, ;36
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x0,0x7,0x7,0x0,0x0,0x2,0x2,0x0,0x7,0x7,0x0,0x0,0x2,0x0,0x7,0x7,0x0,0x0,0xf,0x0,0x7,0x7,0x0,0x0,0xf,0xf,0xf,0xf, ;37
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x2,0x2,0x0,0x0,0x7,0x7,0x0,0x2,0x2,0x0,0x0,0x7,0x7,0x0,0x2,0x0,0x0,0x7,0x7,0x0,0xf,0x0,0x0,0x7,0x7,0x0,0xf,0xf,0xf,0xf,0xf, ;38
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0x0,0x2,0x2,0x0,0x7,0x7,0x7,0x0,0x0,0x2,0x0,0x7,0x7,0x7,0x0,0x0,0x0,0x7,0x7,0x7,0x0,0x0,0x0,0x7,0x7,0x7,0x0,0x0,0xf,0xf,0xf,0xf, ;39
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x7,0x7,0x7,0x8,0x8,0x0,0x0,0xf,0x0,0x0,0x2,0x0,0x7,0x7,0x7,0x7,0x0,0x2,0x0,0x7,0x7,0x7,0x7,0x0,0x0,0x7,0x7,0x7,0x7,0x0,0x0,0x7,0x7,0x7,0x7,0x0,0xf,0xf,0xf,0xf, ;40
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0xf,0x8,0x8,0x8,0x8,0x0,0x0,0xf,0xf,0xf,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xf,0xf,0xf, ;41
       db     0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;42
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x2,0x2,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;43
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x2,0x2,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;44
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x2,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;45
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0x0,0x0,0x0,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;46
       db     0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf,0xf, ;47
 
;e0ter0s d0l t0xto0ext0rn 0ext0ext0rn 0urs0r,l0nes0cur0ent0lin0s.l0ngt0s,l0nes0end0ine0lin0s.s0art0lin0,li0es.0ndl0ne,0ine0.st0rts0lines.line
extern select.start,select.mode
extern text
extern cursor,lines.current,lines.lengths,lines.endline,lines.startsline,lines.endline,lines.starts,lines.line
extern time.getSeconds

section .text

global video.paintIcon
video.paintIcon:
    mov esi,icon
    mov edi,buffer 
    mov ecx,[buffer.height]
    .rows:
    push ecx
    mov ecx,16
    mov ah,0xff
    mov al,220
    rep stosw
    mov ecx,48
    .lpBG:
    lodsb 
    mov ah,al
    shl ah,4
    or ah,[esi+47]
    mov al,220
    stosw
    loop .lpBG
    add esi,48

    mov ecx,16
    mov ah,0xff
    mov al,223
    rep stosw
    pop ecx
    loop .rows
    mov al,0
    mov ah, 0xff
    mov ecx,80
    rep stosw
ret

;Retorna la cantidad de filas que ocupa una linea en la pantalla
    ;push line
    ;return eax = rows 
video.rowsLine:
    startSubR
    mov eax,[ebp+4]
    mov edx,[lines.lengths+4*eax]
    mov eax,edx
    mov ecx,0
    .lp:
    cmp eax,0
    jl .end
    inc ecx
    sub eax,[buffer.width]
    jmp .lp
    .end:
    mov eax,ecx
endSubR 4

;realiza cambio pequennos y continuos en el texto 
global video.invalidate
video.invalidate:
    startSubR 
    call video.RCursor
    
endSubR 0

;Actualiza toda la pantalla
    ;call:
    ;call video.Update
global video.Update
video.Update:
    startSubR
        call video.updateScroll
        call video.UpdateText
        mov dl, [videoflags]
    .tryselection:
        test dl, hideselection
        jnz .trycursor
        call video.UpdateSelection
    .trycursor:
        test dl,  hidecursor
        jnz .trysearch
        call video.UpdateCursor
    .trysearch:
 ;      test al, hidesearch
 ;      jnz .end
 ;      call video.UpdateSearch
   .end:
   call video.UpdateBuffer
   
endSubR 0

video.UpdateBuffer:
  startSubR
        mov esi,buffer.textcache
        mov edi,buffer
        mov ecx,[buffer.height]
        cld
    .rows:
        push ecx
        mov ecx,[buffer.width]
    .columns:
        lodsw               ;eax = ASCII
        cmp al,ASCII.enter  ;si es enter entonces pinto enter
        je .paintEnter
        cmp al,ASCII.tab   ;si es tap entonces pinto taps
        je .paintTab
        cmp al,0
        je .paintEmpty
        stosw
        loop .columns
    .endrow:
        pop ecx
        loop .rows
        jmp .end
    .paintEmpty:
        mov al,'~' 
        stosw                               ;solo pinto una
        dec ecx
        xor al,al
        rep stosw                           ;termino fila
        jmp .endrow
    .paintEnter:
        stosw
        dec ecx
        mov ah,[format.text]
        xor al,al
        rep stosw                           ;pintara el resto de la linea del formato 
        jmp .endrow
    .paintTab:
        jmp .columns
    .end:
endSubR 0 

;actualiza la linea scroll 
 ;call video.updateScroll
video.updateScroll:
    startSubR
       
        mov eax,[scroll]        
        cmp eax,[lines.current]
        je .end
        jb .down
        ja .up
        .up:
       mov edx,[lines.current]
       mov [scroll],edx
       jmp .end
        .down:
        mov ecx,[lines.current]

        sub ecx,[scroll]
        
        inc ecx
        .lpd:
        push eax 
        push eax 
        call video.rowsLine 
        add edx,eax

        cmp edx,[buffer.height]
        jb .nd
        mov eax,[scroll]
        push eax
        call video.rowsLine
        sub edx,eax 
        inc dword [scroll] 
        
        .nd:
        pop eax
        inc eax
        loop .lpd

        .end:
endSubR 0

;pinta en el pre-buffer el cursor
video.UpdateCursor:
    startSubR
    push dword [scroll] 
    call lines.startsline
    mov edx,[cursor]
    sub edx,eax
    mov al,[format.cursor]
    mov [buffer.textcache + 2*edx +1],al
endSubR 0

video.RCursor:
    startSubR
    ;test dword [videoflags],respawcursor
    ;jnz .end
    ;xor dword [videoflags],hidecursor
    ;call video.Update
    ;.end:
endSubR 0


;rasteriza el texto en el formato standart
video.UpdateText:
    startSubR
    mov eax,[scroll]
    push eax 
    call lines.startsline
    lea esi,[text +eax]
    mov edi, buffer.textcache
    mov ecx, buffer.textlength
    cld
    .lp:
    lodsb 
    cmp al,ASCII.enter
    je .enter 
    mov ah,[format.text]
    jmp .stos 
    .enter:
    mov ah,[format.enter]
    .stos:
    stosw
    loop .lp
endSubR 0

;Decide el modo de pintado de selecciones y hace calculos previos  
video.UpdateSelection:
	startSubR
	mov eax,[select.start]
	mov edx,[cursor]
    cmp eax,edx
	jbe .mode
    push eax
    push edx
    pop eax
    pop edx 
    .mode:
	push edx
    push eax
	cmp dword [select.mode],0
	jne .tryline
	call video.UpdateSelection.normal
    jmp .end
    .tryline:
    cmp dword [select.mode],1
	jne .tryblock
	call video.UpdateSelection.line
    jmp .end
    .tryblock:
    call video.UpdateSelection.block
    .end:
endSubR 0

;Pintado Normal de selecciones
    ;call:
    ;push dword end: ebp + 8
    ;push dword start: ebp + 4
video.UpdateSelection.normal:
    startSubR
    mov eax ,[scroll]
    push eax
    call lines.startsline
	cmp eax,[ebp+4]
    jbe .trydown
    mov edx,[ebp+8]
    sub edx,eax
    mov eax,0
    jmp .paint
    .trydown:
	mov edx,[ebp+8]
    sub edx,eax
    mov ecx,eax
    mov eax,[ebp+4]
    sub eax,ecx
    .paint:
	;Se copiaria, desde el principio de la linea hasta el final de mi linea actual
	mov ecx, edx					;la cantidad de movimientos q hago:					
	sub ecx, eax
    inc ecx		
    cmp ecx,1920
    jbe .print
    mov ecx,1920
    .print:		;
	lea edi, [buffer.textcache+2*eax]
    lea esi, [buffer.textcache+2*eax]
    cld
	.lp:
    lodsw
    mov ah,[format.select]
	stosw
    loop .lp
endSubR 8

;Selecciona en modo linea
	;call:
	;push dword end ebp+8
	;push dword start ebp+4
	;call select.line
video.UpdateSelection.line:
 startSubR
	push dword[ebp+4]				;pongo donde empieza mi seleccion como parametro
	call lines.line					;pregunto por la linea de mi seleccion
	mov edx, [lines.starts+4*eax]	;busco el principio de esa linea
	push dword[ebp+8]		        ;pongo mi linea actual como parametro
	call lines.line                 ;busco la linea de mi final como parametro
	push eax                        ;pongo la lina como parametro
	call lines.endline				;busco el final de la linea
    dec eax 
    push eax
    push edx 
    call video.UpdateSelection.normal
	;Se copiaria, desde el principio de la linea de inicio hasta el final de la linea final   
endSubR 8

;Selecciona en modo bloque
video.UpdateSelection.block:
        startSubR
    ;calculo linea final
    push dword [ebp+8]
    call lines.line
    mov ecx,eax                	;calculo cual es la linea final  
    ;calculo caracter final
    push eax 					;salvo linea final
    call lines.startsline
    mov ebx,[ebp+8]
    sub ebx,eax					;ebx = caracter final
    ;calculo linea inicial
    push dword [ebp+4]
    call lines.line
    push eax 					;salvo linea inicial
    ;calculo caracter inicial
    push eax					;se consume con el llamado de abajo
    call lines.startsline		;donde empieza la inicial
    mov edx,[ebp+4]
    sub edx,eax    				;edx = comienza inicial
    pop eax
    cmp eax,[scroll]
    ja ._lp
    mov eax,[scroll]
    ._lp:
    sub ecx,eax					;ecx = cantidad de lineas del bloque
    inc ecx
    .lp:
    mov esi,eax
    push eax
    push eax
    call lines.startsline
    cmp ebx,edx                 ;veo si hay que invertir los valores para enviarselos a select.normal
    ja .invert
    add eax,edx
    push eax 
    sub eax,edx
    add eax,ebx
    push eax 
    jmp .normalcall
    .invert:            ;arreglo de orden de pushs. primero end luego start
    add eax,ebx
    push eax 
    sub eax,ebx
    add eax,edx
    push eax
    .normalcall:
    push esi                                       ;esi tiene la linea actual
    call lines.endline                            
    pop  edi                                    ;edi = inicio
    push edi                                    ;para usar registro y salvar su valor
    cmp edi,eax                                 ;comparo el final de la linea con el inicio de la seleccion
    jb .trycutend                              ;intento ver que pasa con el final
    jmp .nextline                               ;salto de linea
    .trycutend:                                 ;limito si el final de linea es menor que el final entonces el final es el final de linea
    pop edi                                     ;edi = inicio
    pop esi                                     ;esi = final
    cmp esi,eax                                 
    jae .cutend 
    push esi
    push edi
    jmp .paintSelect
    .cutend:
    mov esi,eax
    dec esi 
    push esi
    push edi
    .paintSelect:
    call video.UpdateSelection.normal
    jmp .endlp
    .nextline:
    pop eax
    pop eax
    .endlp:
    pop eax
    inc eax
    loop .lp
endSubR 8

;Marca en el pre-buffer las selecciones
video.UpdateSearch:
    startSubR

endSubR 0







